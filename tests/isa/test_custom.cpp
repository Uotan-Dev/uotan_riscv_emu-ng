/*
 * Copyright 2025 Nuo Shen, Nanjing University
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

#include <gtest/gtest.h>

#include "core/dram.hpp"
#include "device/sifive_test.hpp"
#include "emulator.hpp"

namespace uemu::test {

constexpr size_t TEST_DRAM_SIZE = 32 * 1024 * 1024;

// Execute a simple program for 64 times
TEST(CustomISATest, BasicExecution) {
    constexpr size_t REPEAT_TIMES = 64;

    // https://github.com/Uotan-Dev/uotan_riscv_emu/tree/dev/examples/bare-min
    std::vector<uint8_t> firmware = {
        0x17, 0x01, 0x02, 0x00, 0x13, 0x01, 0x01, 0x00, 0x93, 0x02, 0x00, 0x00,
        0x93, 0x81, 0x02, 0x00, 0x13, 0x82, 0x02, 0x00, 0xef, 0x00, 0x40, 0x06,
        0x6f, 0x00, 0x00, 0x00, 0x13, 0x01, 0x01, 0xfd, 0x23, 0x34, 0x11, 0x02,
        0x23, 0x30, 0x81, 0x02, 0x13, 0x04, 0x01, 0x03, 0x93, 0x07, 0x05, 0x00,
        0x23, 0x2e, 0xf4, 0xfc, 0xb7, 0x07, 0x10, 0x00, 0x23, 0x34, 0xf4, 0xfe,
        0x83, 0x27, 0xc4, 0xfd, 0x9b, 0x97, 0x07, 0x01, 0x9b, 0x87, 0x07, 0x00,
        0x13, 0x87, 0x07, 0x00, 0xb7, 0x57, 0x00, 0x00, 0x93, 0x87, 0x57, 0x55,
        0xb3, 0x67, 0xf7, 0x00, 0x1b, 0x87, 0x07, 0x00, 0x83, 0x37, 0x84, 0xfe,
        0x23, 0xa0, 0xe7, 0x00, 0x13, 0x00, 0x00, 0x00, 0x83, 0x30, 0x81, 0x02,
        0x03, 0x34, 0x01, 0x02, 0x13, 0x01, 0x01, 0x03, 0x67, 0x80, 0x00, 0x00,
        0x13, 0x01, 0x01, 0xfd, 0x23, 0x34, 0x11, 0x02, 0x23, 0x30, 0x81, 0x02,
        0x13, 0x04, 0x01, 0x03, 0x93, 0x07, 0x10, 0x00, 0x23, 0x26, 0xf4, 0xfe,
        0x93, 0x07, 0x20, 0x00, 0x23, 0x24, 0xf4, 0xfe, 0x93, 0x07, 0x30, 0x00,
        0x23, 0x22, 0xf4, 0xfe, 0x83, 0x27, 0xc4, 0xfe, 0x1b, 0x87, 0x07, 0x00,
        0x83, 0x27, 0x84, 0xfe, 0x9b, 0x87, 0x07, 0x00, 0xbb, 0x07, 0xf7, 0x00,
        0x9b, 0x87, 0x07, 0x00, 0x23, 0x20, 0xf4, 0xfe, 0x83, 0x27, 0xc4, 0xfe,
        0x1b, 0x87, 0x07, 0x00, 0x83, 0x27, 0x84, 0xfe, 0x9b, 0x87, 0x07, 0x00,
        0xbb, 0x07, 0xf7, 0x02, 0x9b, 0x87, 0x07, 0x00, 0x23, 0x2e, 0xf4, 0xfc,
        0x83, 0x27, 0x04, 0xfe, 0x1b, 0x87, 0x07, 0x00, 0x83, 0x27, 0xc4, 0xfd,
        0x9b, 0x87, 0x07, 0x00, 0xbb, 0x57, 0xf7, 0x02, 0x9b, 0x87, 0x07, 0x00,
        0x23, 0x2c, 0xf4, 0xfc, 0x83, 0x27, 0x04, 0xfe, 0x1b, 0x87, 0x07, 0x00,
        0x83, 0x27, 0xc4, 0xfd, 0x9b, 0x87, 0x07, 0x00, 0xbb, 0x77, 0xf7, 0x02,
        0x9b, 0x87, 0x07, 0x00, 0x23, 0x2a, 0xf4, 0xfc, 0x13, 0x05, 0x00, 0x00,
        0xef, 0xf0, 0x9f, 0xf0, 0x6f, 0x00, 0x00, 0x00};

    for (size_t i = 0; i < REPEAT_TIMES; i++) {
        Emulator emulator(TEST_DRAM_SIZE);
        emulator.load(core::Dram::DRAM_BASE, firmware);
        emulator.run();
        ASSERT_EQ(emulator.shutdown_code(), 0);
        ASSERT_EQ(emulator.shutdown_status(), device::SiFiveTest::Status::PASS);
    }
}

// Test MachineModeTrap
TEST(CustomISATest, MachineModeException) {
    // https://github.com/Uotan-Dev/uotan_riscv_emu/tree/dev/examples/trap-test
    std::vector<uint8_t> firmware = {
        0x97, 0x02, 0x00, 0x00, 0x93, 0x82, 0x02, 0x03, 0x73, 0x90, 0x52, 0x30,
        0x13, 0x05, 0xa0, 0x00, 0x73, 0x00, 0x00, 0x00, 0xb7, 0x02, 0x10, 0x00,
        0x37, 0x53, 0x00, 0x00, 0x1b, 0x03, 0x53, 0x55, 0x13, 0x15, 0x05, 0x01,
        0x33, 0x65, 0x65, 0x00, 0x23, 0xa0, 0xa2, 0x00, 0x6f, 0x00, 0x00, 0x00,
        0x13, 0x05, 0xa5, 0x02, 0x73, 0x23, 0x10, 0x34, 0x13, 0x03, 0x43, 0x00,
        0x73, 0x10, 0x13, 0x34, 0x73, 0x00, 0x20, 0x30};

    Emulator emulator(TEST_DRAM_SIZE);

    emulator.load(core::Dram::DRAM_BASE, firmware);
    emulator.run();
    EXPECT_EQ(emulator.shutdown_code(), 52);
    EXPECT_EQ(emulator.shutdown_status(), device::SiFiveTest::Status::PASS);
}

} // namespace uemu::test
